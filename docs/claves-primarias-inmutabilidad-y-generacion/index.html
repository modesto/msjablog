<!DOCTYPE html>
<html lang="es-es">
<head>

    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    


    
        <meta name="twitter:card" content="summary"/>
    



<meta name="twitter:title" content="Claves primarias: inmutabilidad y generaciÃ³n"/>
<meta name="twitter:description" content="Hace unos dÃ­asÂ Pablo IglesiasÂ tuiteÃ³Â una pregunta de Stack Exchange en la que hablaban sobre la inmutabilidad de las claves primarias. Se generÃ³ un debate bastante interesante en Twitter que se extendiÃ³ mÃ¡s allÃ¡ de la cuestiÃ³n de la inmutabilidad. Este es un intento de recopilar y explicar algunos deÂ los conceptos que se mencionaron durante ese debate.
Claves primarias mutables o inmutables Para el que ande un poco perdido con el concepto, bÃ¡sicamente se trata de determinar si la clave primaria de una entidad deberÃ­a poder cambiar o no una vez establecida."/>

    <meta name="twitter:site" content="@msanjuan"/>



  	<meta property="og:title" content=" Claves primarias: inmutabilidad y generaciÃ³n &middot;  Blog de Modesto San Juan" />
  	<meta property="og:site_name" content="Blog de Modesto San Juan" />
  	<meta property="og:url" content="http://www.modestosanjuan.com/claves-primarias-inmutabilidad-y-generacion/" />

    
  	<meta property="og:type" content="article" />

    <meta property="og:article:published_time" content="2016-07-30T23:39:11Z" />

    
    

    <title>
       Claves primarias: inmutabilidad y generaciÃ³n &middot;  Blog de Modesto San Juan
    </title>

    <meta name="description" content="DESCUBRIMIENTOS, IDEAS Y OTRAS CHORRADAS" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="http://www.modestosanjuan.com/images/favicon.ico">
	  <link rel="apple-touch-icon" href="http://www.modestosanjuan.com/images/apple-touch-icon.png" />

    <link rel="stylesheet" type="text/css" href="http://www.modestosanjuan.com/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="http://www.modestosanjuan.com/css/nav.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400|Inconsolata" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/arta.min.css">

    
      
          <link href="http://www.modestosanjuan.com/index.xml" rel="alternate" type="application/rss+xml" title="Blog de Modesto San Juan" />
      
      
    
    <meta name="generator" content="Hugo 0.81.0" />

    <link rel="canonical" href="http://www.modestosanjuan.com/claves-primarias-inmutabilidad-y-generacion/" />

    
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-58663898-1', 'auto');
      ga('send', 'pageview');

    </script>
    

    
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
</head>
<body class="nav-closed">

  <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        
        
        
    </ul>
    
    
    <a class="subscribe-button icon-feed" href="http://www.modestosanjuan.com/index.xml">Subscribe</a>
    
</div>
<span class="nav-cover"></span>


 <div class="site-wrapper">




<header class="main-header post-head no-cover">
  <nav class="main-nav clearfix">


  
      <a class="blog-logo" href="http://www.modestosanjuan.com/"><img src="http://www.modestosanjuan.com/images/logo.jpg" alt="Home" /></a>
  
  
      <a class="menu-button icon-feed" href="http://www.modestosanjuan.com/index.xml">&nbsp;&nbsp;Subscribe</a>
  
  </nav>
</header>



<main class="content" role="main">




  <article class="post post">

    <header class="post-header">
        <h1 class="post-title">Claves primarias: inmutabilidad y generaciÃ³n</h1>
        <small></small>

        <section class="post-meta">
        
          <time class="post-date" datetime="2016-07-30T23:39:11Z">
            Jul 30, 2016
          </time>
        
         
        </section>
    </header>

    <section class="post-content">
      <p>Hace unos dÃ­asÂ <a href="https://twitter.com/Pablyte/status/754056720666730500">Pablo Iglesias</a>Â <a href="https://twitter.com/Pablyte/status/754056720666730500">tuiteÃ³</a>Â una pregunta de Stack Exchange en la que hablaban sobre la inmutabilidad de las claves primarias. Se generÃ³ un debate bastante interesante en Twitter que se extendiÃ³ mÃ¡s allÃ¡ de la cuestiÃ³n de la inmutabilidad. Este es un intento de recopilar y explicar algunos deÂ los conceptos que se mencionaron durante ese debate.</p>
<h1 id="claves-primarias-mutables-o-inmutables">Claves primarias mutables o inmutables</h1>
<p>Para el que ande un poco perdido con el concepto, bÃ¡sicamente se trata de determinar si la clave primaria de una entidad deberÃ­a poder cambiar o no una vez establecida. Por ejemplo: si me registro en un servicio online y utilizan mi email como PK, si el servicio me da la opciÃ³n de cambiar mi cuenta de correo, la PKÂ es mutable. Esto significa que en todos los sitios en los que el servicio se estÃ© persistiendo mi email como PKÂ va a tener que actualizar el dato para constatar el cambio. Independientemente de que usemos o no foreign keys, esto es un foco de dolor, especialmenteÂ si utilizamos distintos mecanismos de persistencia de datos. Si ademÃ¡s nuestro software cuenta con funcionalidades como con auditar los cambios o cualquier tipo de integraciÃ³n con sistemas externos como herramientas de CRM y similar, tener PKs mutables se puede convertir en algo imposible.</p>
<p>Parece que hubo un consenso generalizado respecto a que las PK deberÃ­an ser inmutables, asÃ­ que no me voy a extender mÃ¡s en este punto.</p>
<h1 id="claves-subrogadas-o-naturales">Claves subrogadas o naturales</h1>
<p>Cuando usamos una clave natural, el valor de la clave estÃ¡ relacionado con los datos que identifica. Por ejemplo, si estamos identificando libros, el ISBN podrÃ­a ser un candidato a PK.Â El nÃºmero de bastidor para un coche, nÃºmero de serie de un ordenador, la MAC de una tarjeta de red, el nÃºmero de una factura, etc.Â En resumen, utilizamos un dato del negocio para identificar nuestras entidadesÂ al persistirlas.</p>
<p>Si, por otro lado, elegimos usar una clave subrogada, lo que estamos haciendo es generar un identificador Ãºnico que no tiene nada que ver con los datos que identifica, pero se garantiza a nivel infraestructura que el dato es Ãºnico.</p>
<p>Aunque siempre pongo un gran â€œdependeâ€ y no soy muy amigo de las afirmaciones absolutas, la realidad es que llevo aÃ±os utilizando claves subrogadas porque la experiencia me ha demostradoÂ que suele ser una mala idea utilizar datos del negocio. La razÃ³n es muy sencilla: el negocio cambia.</p>
<p>Ejemplos hay miles. Por tomar uno,Â <a href="https://twitter.com/panicoenlaxbox">Sergio LeÃ³n</a>Â mencionaba los ISBN de los libros.Â Desarrollando un software para gestionar liberÃ­as podrÃ­amos pensar que el ISBN deberÃ­a valernos, pero los libros muy viejos no tienen ISBN. AsÃ­ que si de repente al librero le diese por dedicarse a vender libros antiguos de colecciÃ³n, tendrÃ­amos un problema importante. Ese tipo de situacionesÂ se dan con mucha frecuencia y siempreÂ cuando el desarrollo ya estÃ¡ bastante avanzado, que es cuando mÃ¡s daÃ±o hacen.</p>
<p>Como el ejemplo del ISBN hay muchos y debemos tener en cuenta el coste del cambio. Hay quiÃ©n podrÃ­a utilizar el argumento de que es un error pensar en el futuro y que usar una clave subrogada es una decisiÃ³n prematura basada en anticiparse a un posible cambio de negocio que no sabemos si alguna vez va a suceder. En esas circunstancias suele ser un buen ejercicio pensar en cuÃ¡l serÃ­a el coste del cambio en el futuro frente al coste de usar una clave subrogada en el presente. Si lo pensamos en tÃ©rminos econÃ³micos, utilizar una clave natural podrÃ­a implicar estar firmando una hipoteca muy cara.</p>
<p>AdemÃ¡s, comoÂ indicaba <a href="https://twitter.com/pmolinam">Pedro J. Molina</a>, â€œSi vas por clave natural acaba uno fÃ¡cilmente con claves compuestas. Las de 4 campos ya no hacen graciaâ€. Pero es que encima eso termina tocando mucho las narices cuando llega el momento de â€œenchufarteâ€ a otras cosas. Es tÃ­pico que el servicio que te permite asociar comentarios, likes, etc. te pida que le des un identificadorÂ Ãºnico de tu entidad y nos podrÃ­amos volver locos buscando ejemplos que nos llevan a desear trabajar siempre con una clave subrogada.</p>
<h2 id="generaciÃ³n-de-las-claves-subrogadas">GeneraciÃ³n de las claves subrogadas</h2>
<p>Venga, vamos a suponer que a estas alturas ya estamos convencidos de que vamos a identificar a nuestras entidades con claves inmutables y subrogadas al menos algunas veces. Â¿CÃ³mo las generamos? Este punto tambiÃ©n generÃ³ debate yÂ en este caso no habÃ­aÂ unanimidad ni de lejos.</p>
<p>Para generar una clave subrogada podemos optar por dejar que la base de datos la genere por nosotros automÃ¡ticamente cuando insertamos el registro o podemos ser nosotros desde el cÃ³digo los que proporcionemos la clave a la base de datos.</p>
<p>La opciÃ³n clÃ¡sica es que la base de datos genere el identificador por ti y listo. Podemos usar unÂ identity, secuencia o lo que nos proporcione la base de datos que utilicemos y no nos complicamos mucho la vida. Pero hay escenarios en los queÂ nos podrÃ­a interesar recurrir a otro tipo de mecanismos.</p>
<h2 id="mecanismos-para-la-generaciÃ³n-de-claves-subrogadas">Mecanismos para la generaciÃ³n de claves subrogadas</h2>
<p>Aunque podrÃ­amos ponernos muy creativos de cara a la generaciÃ³n de nuestras claves, hay ciertos mecanismos predominantes. No voy a posicionarme respecto a ninguno porque creo que su utilizaciÃ³n depende mucho de los requisitos del negocio y de la infraestructura de la aplicaciÃ³n.</p>
<h3 id="guids">Guids</h3>
<p>Generar Guids es algo sencillo, se puede hacer desde cualquier sitio y las posibilidades de colisiÃ³n son absolutamente despreciables. En principio es un mecanismo interesante ya que nos permite tener el control desde el negocio y no depender deÂ la base de datos para su generaciÃ³n. AdemÃ¡s, entre sus virtudes podemos considerar que al usar un Guid estamos utilizando un identificadorÂ no sÃ³lo aÂ la tabla, tambiÃ©n entre todas las tablas e incluso entre varias bases de datos. Esto habilita con mucha mÃ¡s facilidad escenarios de â€œmergeâ€ en los que queremos juntar datos que provienen de varias fuentes.</p>
<p>Por supuesto, tambiÃ©n tiene sus contras, entre ellos que un Guid ocupa muchÃ­simo mÃ¡s que una clave numÃ©rica y ademÃ¡s <a href="http://sqlmag.com/database-performance-tuning/clustered-indexes-based-upon-guids">afecta negativamente</a> al rendimiento de los Ã­ndices clustered.</p>
<p>Hay mucha literatura sobre este tema en internet, incluyendo algunos intentos de anÃ¡lisis sobre la diferencia desde el punto de vista de rendimiento. AdemÃ¡s debemos tener en cuenta que la implementaciÃ³n de base de datos que utilicemos influye muchÃ­simo. Como ejemplo, no es lo mismo usar <a href="http://krow.livejournal.com/497839.html">MySQL</a> que <a href="http://www.informit.com/articles/printerfriendly/25862">SQL Server</a>.</p>
<h3 id="numÃ©ricoautoincrementado">NumÃ©ricoÂ autoincrementado</h3>
<p>EsteÂ mecanismo es uno de los mÃ¡s frecuentes y creo que no necesita mucha explicaciÃ³n. El standard SQL:2003 define los tipos IDENTITY y SEQUENCE pero dependemos de la base de datos que estemos utilizando. Por ejemplo, en MySQL estÃ¡ elÂ AUTO_INCREMENT y en PostgreSQL tambiÃ©n estÃ¡ el SERIAL (creo que es â€œazucar sintÃ¡cticoâ€ para definir un SEQUENCE).</p>
<h3 id="hilo">HiLo</h3>
<p>A grandes rasos, con HiLo la aplicaciÃ³n reservaÂ con antelaciÃ³n en la base de datosÂ un rango de identificadores que serÃ¡n utilizados necesiteÂ insertar nuevos registros en la base de datos. Cuando la aplicaciÃ³n ha usado todos los identificadores, va a la base de datos y reserva mÃ¡s. NHibernate usa esta tÃ©cnica y tambiÃ©n es posibleÂ usarla en Entity Framework. Entre sus ventajasÂ estÃ¡ que nos permite utilizar identificadores de tipo numÃ©rico (para los que demandan rendimiento)Â y entre las desventajas que genera â€œlagunasâ€ entre los identificadores generados. Si una aplicaciÃ³n reserva losÂ identificadores del 1 al 10 y luego usa Ãºnicamente 5, los identificadores de 6 al 10 quedarÃ¡n sin usar.</p>
<h3 id="dependiendo-de-un-tercero">Dependiendo de un tercero</h3>
<p>Consiste en delegar en un tercero la estrategia de generaciÃ³n de nuestra clave. Desde nuestra aplicaciÃ³n, cuando queramos identificar una entidad, llamaremos a este servicio externo y nos proporcionarÃ¡ una identidadÂ que serÃ¡ la que luego persistiremos.</p>
<p>Cuando estamos haciendo HiLo, en parte estamos utilizando este mecanismo. Aunque sea nuestraÂ base de datos la que genera los identificadores, en realidad es un tercero (la clase que gestiona el algoritmo) el que nos los estÃ¡ proporcionando.</p>
<p>Un ejemplo (raro pero real)Â esÂ utilizarlo cuando laÂ persistencia se realiza sobre mecanismos que no tienen soporte de autonumÃ©ricos, delegando la generaciÃ³n del autonumÃ©rico sobre un tercero para luego persistir el dato. Otro escenario de uso serÃ­a si necesitamos asegurarnos de que nuestros identificadores son Ãºnicos entre varios sistemas y ademÃ¡s queremos aplicar reglas especiales para su generaciÃ³n.</p>
<p>Siendo realistas, es un mecanismo que aÃ±ade complejidad y no es necesario la mayorÃ­a de las veces, pero no deja de ser interesante mencionarlo.</p>
<h2 id="cuÃ¡l-uso">Â¿CuÃ¡l uso?</h2>
<p>SegÃºn las respuestas a la conversaciÃ³n que originÃ³ el debate, una gran mayorÃ­a responderÃ­a â€œsecuencias numÃ©ricas autoincrementadasÂ y no me complicoâ€. No les falta razÃ³n, pero hay veces queÂ complicarnos es la opciÃ³n menos complicada. Complicado, eh? ğŸ˜‰</p>
<p>Existen muchas razones que podrÃ­an llevarnos a querer complicarnos la vida y no pretendo hacer un estudio detallado, pero al menos quiero poner algunos ejempos comunes.</p>
<h3 id="cqs">CQS</h3>
<p>Si queremosÂ usarÂ <a href="http://martinfowler.com/bliki/CommandQuerySeparation.html">CQS</a> (Command-Query Separation) partimos del principio de que nuestros comandos no devuelvenÂ nada. Si tenemos un comando que inserta una entidad,Â deberÃ­amos saber el id de la entidad que estamos insertando antes de llamar al propio comando, ya que el comando no va a devolvernos nada.</p>
<p>PodrÃ­amos pensar que tampoco pasa nada porque un comando de inserciÃ³n devuelva un valor y ya estÃ¡. No voy a entrar a valorar esto, pero en cuanto queramos que el modelo de ejecuciÃ³n de nuestros comandos sea asÃ­ncrono (a travÃ©s de una cola o similar), volvemos al problema inicial.</p>
<h3 id="modo-offline">Modo offline</h3>
<p>SiÂ nuestra aplicaciÃ³n tiene como requisito de negocio proporcionarÂ la posibilidad trabajar offline, recurrir al servidor de base de datos para obtener el id de una entidad no es una opciÃ³n.</p>
<p>Imaginemos una aplicaciÃ³n como Evernote. Cuando creemos una nueva nota y no tengamos conexiÃ³n, Â¿quÃ© identificador tendrÃ¡ esa nota entonces? Si generamos ese identificador desde el cÃ³digo (mediante, por ejemplo, un GUID) podremos realizar la sincronizaciÃ³n fÃ¡cilmente una vez tengamos conexiÃ³n.</p>
<p>Aunque en el caso de CQS, HiLo podrÃ­a ser una opciÃ³n perfectamente vÃ¡lida, en este caso serÃ­a la opciÃ³n menos recomendada ya que tendrÃ­amos la necesidad de conectarnos al servidor de base de datos si creamos tantas entidades que agotamos nuestro â€œcupoâ€ de identificadores.</p>
<h3 id="si-no-usamos-sql">Si no usamos SQL</h3>
<p>Este casoÂ es ignorado por muchos desarrolladores cuyo contexto profesional se limita a bases de datosÂ SQL para persistir informaciÃ³n. Cuando salimos del mundo SQL,Â muchÃ­simosÂ mecanismos de persistencia piden que seamos nosotros desde el cÃ³digo los que proporcionemos nuestros identificadores.Â Como ejemplo â€œprimitivoâ€ a la par que Ãºtil,Â si persistimos en disco tendremos que proporcionar nosotros el identificador de nuestra entidad (nombre del archivo).</p>
<h1 id="conclusiones">Conclusiones</h1>
<p>Tenemos multitud de mecanismos para identificar nuestras entidades. Debemos conocerlos bien y hacer un uso inteligente de ellos en funciÃ³n de nuestros requisitos de negocio, pero nunca complicarnos la vida innecesariamente.Y muy importante, que el rendimiento Ãºnicamente sea un argumento cuando tenemos requisitos no funcionales que nos hablan de rendimiento. Hablar de rendimiento cuando no tienes requisitos relacionados con el rendimiento suele ser foco de optimizaciones prematuras.</p>
<p>Y con esto creo que termino el â€œresumenâ€ de las cosas que se comentaron en el hilo de Twitter y algunas de las que pasaron por mi cabeza. Seguro que me dejo en el tintero muchas observaciones y muchos matices,Â me conformo si a alguien le vale para entenderÂ que hay vida mÃ¡s allÃ¡ de los identificadores mutables naturales ğŸ˜€</p>

    </section>


  <footer class="post-footer">


    
    <figure class="author-image">
        <a class="img" href="http://www.modestosanjuan.com/" style="background-image: url(http://www.modestosanjuan.com/images/logo.jpg)"><span class="hidden">Modesto San Juan's Picture</span></a>
    </figure>
    

    





<section class="author">
  <h4><a href="http://www.modestosanjuan.com/">Modesto San Juan</a></h4>
  
  <p>Desarrollo software e intento hacerlo bien</p>
  
  <div class="author-meta">
    <span class="author-location icon-location">Madrid, Spain</span>
    <span class="author-link icon-link"><a href="http://www.modestosanjuan.com">http://www.modestosanjuan.com</a></span>
  </div>
</section>



    
<section class="share">
  <h4>Share this post</h4>
  <a class="icon-twitter" style="font-size: 1.4em" href="https://twitter.com/share?text=Claves%20primarias%3a%20inmutabilidad%20y%20generaci%c3%b3n&nbsp;-&nbsp;Blog%20de%20Modesto%20San%20Juan&amp;url=http%3a%2f%2fwww.modestosanjuan.com%2fclaves-primarias-inmutabilidad-y-generacion%2f"
      onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
      <span class="hidden">Twitter</span>
  </a>
  <a class="icon-facebook" style="font-size: 1.4em" href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fwww.modestosanjuan.com%2fclaves-primarias-inmutabilidad-y-generacion%2f"
      onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
      <span class="hidden">Facebook</span>
  </a>
  <a class="icon-pinterest" style="font-size: 1.4em" href="http://pinterest.com/pin/create/button/?url=http%3a%2f%2fwww.modestosanjuan.com%2fclaves-primarias-inmutabilidad-y-generacion%2f&amp;description=Claves%20primarias%3a%20inmutabilidad%20y%20generaci%c3%b3n"
      onclick="window.open(this.href, 'pinterest-share','width=580,height=296');return false;">
      <span class="hidden">Pinterest</span>
  </a>
  <a class="icon-google-plus" style="font-size: 1.4em" href="https://plus.google.com/share?url=http%3a%2f%2fwww.modestosanjuan.com%2fclaves-primarias-inmutabilidad-y-generacion%2f"
     onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
      <span class="hidden">Google+</span>
  </a>
</section>



    

<div id="disqus_thread"></div>
<script type="text/javascript">
  var disqus_shortname = 'modestosanjuan';
  var disqus_url = 'http:\/\/www.modestosanjuan.com\/claves-primarias-inmutabilidad-y-generacion\/';
  (function() {
    if (window.location.hostname == "localhost")
          return;
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>




  </footer>
</article>

</main>
    <footer class="site-footer clearfix">
        <section class="copyright"><a href="">Blog de Modesto San Juan</a> </section>
        
        <section class="poweredby">Proudly generated by <a class="icon-hugo" href="http://gohugo.io">HUGO</a>, with <a class="icon-theme" href="https://github.com/vjeantet/hugo-theme-casper">Casper</a> theme</section>
        
    </footer>
    </div>
    <script type="text/javascript" src="http://www.modestosanjuan.com/js/jquery.js"></script>
    <script type="text/javascript" src="http://www.modestosanjuan.com/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="http://www.modestosanjuan.com/js/index.js"></script>
    
</body>
</html>

